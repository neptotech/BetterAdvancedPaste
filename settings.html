<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Settings</title>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<style>
  :root {
    --bg:#fff; --border:#d2d2d2; --text:#1e1e1e; --muted:#666; --accent:#2563eb;
    --font: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;
  }
  html,body{margin:0;padding:0;background:transparent;font-family:var(--font);color:var(--text)}
  .wrap{padding:14px}
  .field{display:flex;flex-direction:column;gap:6px;margin-bottom:12px}
  input[type="text"], input[type="password"]{border:1px solid var(--border);border-radius:8px;padding:8px 10px;font-size:14px;width:auto}
  .row{display:flex;gap:8px;align-items:center}
  .btn{border:1px solid var(--border);background:#fff;border-radius:8px;padding:8px 12px;cursor:pointer}
  .btn.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
  .muted{color:var(--muted);font-size:12px}
</style>
</head>
<body>
  <div class="wrap">
    <h3 style="margin:0 0 10px 0;">API Token</h3>
    <div class="field">
      <label for="token">OpenAI API Token</label>
      <input id="token" type="text" placeholder="sk-..." />
      <div class="muted">Stored securely in your OS keyring. Leaving empty will remove the token.</div>
    </div>
    <div class="row" style="justify-content:flex-end">
      <button id="saveBtn" class="btn primary">Save & Close</button>
    </div>
  </div>
  <script>
    async function loadToken(){
      if(window.pywebview && window.pywebview.api && window.pywebview.api.get_api_token){
        try {
          const tok = await window.pywebview.api.get_api_token();
          const el = document.getElementById('token');
          if(typeof tok === 'string') el.value = tok;
        } catch(e){ console.warn('Failed to load token', e); }
      }
    }

    async function saveToken(){
      const btn = document.getElementById('saveBtn');
      if(btn){ btn.disabled = true; btn.textContent = 'Savingâ€¦'; }
      const el = document.getElementById('token');
      const value = (el.value || '').trim();
      if(window.pywebview && window.pywebview.api && window.pywebview.api.set_api_token){
        try { await window.pywebview.api.set_api_token(value); } catch(e){ console.warn('Failed to save token', e); }
      }
      // request popup close from backend
      if(window.pywebview && window.pywebview.api && window.pywebview.api.close_settings){
        try { await window.pywebview.api.close_settings(); } catch(e){ }
      }
      // No client-side close to avoid race conditions; backend will hide/destroy
    }

    document.getElementById('saveBtn').addEventListener('click', saveToken);

    window.addEventListener('pywebviewready', loadToken);
    loadToken();
  </script>
</body>
</html>